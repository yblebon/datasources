<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top 50 US Songs - Weekly Chart</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }
        header {
            background-color: #1a73e8;
            color: white;
            text-align: center;
            padding: 2rem;
        }
        h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #1a73e8;
            color: white;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .rank {
            width: 10%;
            font-weight: bold;
        }
        .song-title {
            width: 25%;
        }
        .artist {
            width: 25%;
        }
        .weeks {
            width: 15%;
        }
        .peak {
            width: 15%;
        }
        .lyrics {
            width: 10%;
        }
        .error {
            color: red;
            text-align: center;
            margin: 20px;
        }
        footer {
            text-align: center;
            padding: 1rem;
            background-color: #1a73e8;
            color: white;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        @media (max-width: 600px) {
            h1 {
                font-size: 1.5rem;
            }
            th, td {
                padding: 10px;
                font-size: 0.9rem;
            }
            .rank, .weeks, .peak, .lyrics {
                width: 20%;
            }
            .song-title, .artist {
                width: 25%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1 id="chart-title">Top 50 US Songs - Weekly Chart</h1>
    </header>
    <div class="container">
        <table id="chart-table">
            <thead>
                <tr>
                    <th class="rank">Rank</th>
                    <th class="song-title">Song Title</th>
                    <th class="artist">Artist</th>
                    <th class="weeks">Weeks on Chart</th>
                    <th class="peak">Peak Position</th>
                    <th class="lyrics">Lyrics</th>
                </tr>
            </thead>
            <tbody id="chart-body">
                <!-- Data will be populated by JavaScript -->
            </tbody>
        </table>
        <p id="error-message" class="error" style="display: none;"></p>
        <p><em>Data sourced from Billboard Hot 100. For the full list, visit <a href="https://www.billboard.com/charts/hot-100/">Billboard Hot 100</a>. Lyrics links provided by Genius.</em></p>
    </div>
    <footer>
        <p>Chart updated weekly based on streaming, airplay, and sales data. Â© 2025</p>
    </footer>

    <script>
        // Function to format string for Genius URL
        function formatForGenius(str) {
            return str
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                .replace(/\s+/g, '-')          // Replace spaces with hyphens
                .replace(/-+/g, '-');          // Remove duplicate hyphens
        }

        // Function to generate Genius lyrics URL
        function getLyricsUrl(song, artist) {
            const formattedSong = formatForGenius(song);
            const formattedArtist = formatForGenius(artist.split(' & ')[0]); // Use primary artist
            return `https://genius.com/${formattedArtist}-${formattedSong}-lyrics`;
        }

        // Function to get the closest Saturday's date
        function getClosestSaturday() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = dayOfWeek >= 6 ? 6 - dayOfWeek : -dayOfWeek;
            const saturday = new Date(today.setDate(today.getDate() + diff));
            return saturday.toISOString().split('T')[0];
        }

        async function fetchValidDates() {
            const url = 'https://raw.githubusercontent.com/mhollingshead/billboard-hot-100/main/valid_dates.json';
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to fetch valid dates');
                }
                const dates = await response.json();
                return dates;
            } catch (error) {
                console.error('Error fetching valid dates:', error);
                return [];
            }
        }

        async function fetchChartData() {
            const tbody = document.getElementById('chart-body');
            const errorMessage = document.getElementById('error-message');
            const chartTitle = document.getElementById('chart-title');
            let chartDate = getClosestSaturday();
            let url = `https://raw.githubusercontent.com/mhollingshead/billboard-hot-100/main/date/${chartDate}.json`;

            try {
                let response = await fetch(url);
                if (!response.ok) {
                    // If the date is invalid, fetch valid dates and try the most recent one
                    const validDates = await fetchValidDates();
                    if (validDates.length === 0) {
                        throw new Error('No valid dates available');
                    }
                    chartDate = validDates[validDates.length - 1]; // Use the most recent valid date
                    url = `https://raw.githubusercontent.com/mhollingshead/billboard-hot-100/main/date/${chartDate}.json`;
                    response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                }
                const chart = await response.json();

                // Update chart title with the date
                chartTitle.textContent = `Top 50 US Songs - Weekly Chart (${chartDate})`;

                // Clear existing table content
                tbody.innerHTML = '';

                // Ensure data exists and is an array
                if (!chart.data || !Array.isArray(chart.data)) {
                    throw new Error('Invalid chart data format');
                }

                // Populate table with top 50 songs
                chart.data.slice(0, 50).forEach((song, index) => {
                    const lyricsUrl = getLyricsUrl(song.song, song.artist);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="rank">${song.this_week}</td>
                        <td class="song-title">${song.song}</td>
                        <td class="artist">${song.artist}</td>
                        <td class="weeks">${song.weeks_on_chart}</td>
                        <td class="peak">${song.peak_position}</td>
                        <td class="lyrics"><a href="${lyricsUrl}" target="_blank">View Lyrics</a></td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching chart data:', error);
                errorMessage.textContent = 'Failed to load chart data. Please try again later.';
                errorMessage.style.display = 'block';
            }
        }

        // Fetch data when the page loads
        window.onload = fetchChartData;
    </script>
</body>
</html>
